

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Class DataLogger &mdash; Datalogger 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Datalogger 1 documentation" href="../index.html"/>
        <link rel="up" title="Code explained" href="../code.html"/>
        <link rel="next" title="Class LedManager" href="led_manager.html"/>
        <link rel="prev" title="Code explained" href="../code.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Datalogger</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Minimum requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installationguide.html">Installation guide</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../code.html">Code explained</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">Class DataLogger</a></li>
<li class="toctree-l2"><a class="reference internal" href="led_manager.html">Class LedManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_manager.html">Class PacketManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection_manager.html">Class ConnectionManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="read_sensor_scheduler.html">Class ReadSensorScheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration_manager.html">Class ConfigurationManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="log_handlers_and_filters.html">Class LogSendStoreHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="modbus_slave_reader.html">Class ModbusSlaveReader</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/modules.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/datalogger.html">datalogger module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/connection_manager.html">connection_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/packet_manager.html">packet_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/log_handlers_and_filters.html">log_handlers_and_filters module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/configuration_manager.html">configuration_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/configuration.html">configuration module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/led_manager.html">led_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/mcu_modbus_slave_reader.html">mcu_modbus_slave_reader module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/mcu_read_sensor_scheduler.html">mcu_read_sensor_scheduler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modbus_slave_reader.html">modbus_slave_reader module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/read_random_scheduler.html">read_random_scheduler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/read_sensor_scheduler.html">read_sensor_scheduler module</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Datalogger</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../code.html">Code explained</a> &raquo;</li>
      
    <li>Class DataLogger</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/code/datalogger.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="class-datalogger">
<h1>Class DataLogger<a class="headerlink" href="#class-datalogger" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#data-init"><em>__init__()</em></a></li>
<li><a class="reference internal" href="#load-online-configuration-and-initiate-sending-data"><em>load_online_configuration_and_initiate_sending_data()</em></a></li>
<li><a class="reference internal" href="#wait-for-connection-to-load-configuration"><em>wait_for_connection_to_load_configuration()</em></a></li>
<li><a class="reference internal" href="#try-to-connect-to-internet"><em>try_to_connect_to_internet()</em></a></li>
<li><a class="reference internal" href="#try-to-load-online-configuration"><em>try_to_load_online_configuration()</em></a></li>
<li><a class="reference internal" href="#set-up-led-manager-calls"><em>set_up_led_manager_calls()</em></a></li>
</ul>
</div></blockquote>
<div class="section" id="init">
<span id="data-init"></span><h2>__init__()<a class="headerlink" href="#init" title="Permalink to this headline">¶</a></h2>
<p>In the intialisation method of the <a class="reference internal" href="../modules/datalogger.html#datalogger.DataLogger" title="datalogger.DataLogger"><tt class="xref py py-class docutils literal"><span class="pre">DataLogger</span></tt></a> class, the code is encapsulated in an try-except block to catch possible errors that arise. If an error arises, before ending the datalogger the logs are sent to the server.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
  <span class="o">...</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">send_logs_job</span><span class="p">()</span>
  <span class="k">raise</span>
</pre></div>
</div>
<p>In the try-except block, following systems are initialised:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler" title="log_handlers_and_filters.LogSendStoreHandler"><tt class="xref py py-class docutils literal"><span class="pre">LogSendStoreHandler</span></tt></a></li>
<li><a class="reference internal" href="../modules/configuration_manager.html#configuration_manager.ConfigurationManager" title="configuration_manager.ConfigurationManager"><tt class="xref py py-class docutils literal"><span class="pre">ConfigurationManager</span></tt></a></li>
<li><tt class="xref py py-class docutils literal"><span class="pre">Scheduler</span></tt></li>
<li><a class="reference internal" href="../modules/packet_manager.html#packet_manager.PacketManager" title="packet_manager.PacketManager"><tt class="xref py py-class docutils literal"><span class="pre">PacketManager</span></tt></a></li>
<li><a class="reference internal" href="../modules/connection_manager.html#connection_manager.ConnectionManager" title="connection_manager.ConnectionManager"><tt class="xref py py-class docutils literal"><span class="pre">ConnectionManager</span></tt></a></li>
</ul>
</div></blockquote>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger"> [api]</a><div class="highlight"><pre>            <span class="c"># initiate logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span> <span class="o">=</span> <span class="n">LogSendStoreHandler</span><span class="p">(</span><span class="n">LOG_LOCATION</span><span class="p">)</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> - </span><span class="si">%(levelname)s</span><span class="s"> - </span><span class="si">%(name)s</span><span class="s"> - </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Initialising system...&#39;</span><span class="p">)</span>
            <span class="n">job_info_filter</span> <span class="o">=</span> <span class="n">JobInfoFilter</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;apscheduler.scheduler&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span>
                <span class="n">job_info_filter</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;apscheduler.threadpool&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span>
                <span class="n">job_info_filter</span><span class="p">)</span>

            <span class="c"># load local configuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf_man</span> <span class="o">=</span> <span class="n">ConfigurationManager</span><span class="p">(</span><span class="n">CONFIG_LOCATION</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span> <span class="o">=</span> <span class="n">PacketManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">)</span>

            <span class="c"># initiate network connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">ConnectionManager</span><span class="p">()</span>

            <span class="c"># add scheduler and connection to log handler</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">(</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span>
                <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, if there is a connection to the server, the online configuration is compared to the local one on the basis of a checksum. This happens in <a class="reference internal" href="#load-online-configuration-and-initiate-sending-data"><em>load_online_configuration_and_initiate_sending_data()</em></a>. After that the time is synchronised in <a class="reference internal" href="packet_manager.html#update-time"><em>update_time()</em></a> and the <a class="reference internal" href="../modules/packet_manager.html#module-packet_manager" title="packet_manager"><tt class="xref py py-class docutils literal"><span class="pre">packet_manager</span></tt></a> starts sending packets to the server in <a class="reference internal" href="packet_manager.html#initiate-send-packets"><em>initiate_send_packets(connection)</em></a>.
If there is no connection to the server a job is started that, as soon as the connection to the server is back, checks and optionally updates the configuration.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger"> [api]</a><div class="highlight"><pre>            <span class="c"># try to connect</span>
            <span class="n">connected_to_internet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_internet_connection</span><span class="p">()</span>
            <span class="n">connected_to_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_server_connection</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">connected_to_internet</span> <span class="ow">and</span> <span class="n">connected_to_server</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_online_configuration_and_initiate_sending_data</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">update_time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">initiate_send_packets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                if there is no connection:</span>
<span class="sd">                    keep checking for a connection</span>
<span class="sd">                    temporarily use offline timer and modbus slave</span>
<span class="sd">                    configuration</span>
<span class="sd">                &#39;&#39;&#39;</span>

                <span class="k">if</span> <span class="n">connected_to_internet</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">update_time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_connection_to_load_configuration</span><span class="p">()</span>
</pre></div>
</div>
<p>After that, the <a class="reference internal" href="../modules/read_sensor_scheduler.html#read_sensor_scheduler.ReadSensorScheduler" title="read_sensor_scheduler.ReadSensorScheduler"><tt class="xref py py-class docutils literal"><span class="pre">ReadSensorScheduler</span></tt></a> is started and the led manager is initialised. A message is showed to make clear that the initialisation is complete.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger"> [api]</a><div class="highlight"><pre>            <span class="c"># initiate sensor timers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_sensor_scheduler</span> <span class="o">=</span> <span class="n">ReadSensorScheduler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_manager</span> <span class="o">=</span> <span class="n">LedManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_manager</span><span class="o">.</span><span class="n">update_led</span><span class="p">(</span><span class="n">PinName</span><span class="o">.</span><span class="n">powered</span><span class="p">,</span> <span class="n">LedState</span><span class="o">.</span><span class="n">on</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_up_led_manager_calls</span><span class="p">()</span>

            <span class="c"># sleep 2 seconds to intialise led of log handler</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Initialisation complete&#39;</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Alive and kicking&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="ow">is</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">scheduler_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scheduler_jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Current scheduler jobs:&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scheduler_jobs</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39; Job {0}: {1} {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">index</span><span class="p">,</span>
                                <span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">job</span><span class="o">.</span><span class="n">next_run_time</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;No running scheduler jobs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="load-online-configuration-and-initiate-sending-data">
<span id="id1"></span><h2>load_online_configuration_and_initiate_sending_data()<a class="headerlink" href="#load-online-configuration-and-initiate-sending-data" title="Permalink to this headline">¶</a></h2>
<p>First the online configuration checksum is requested and compared to the local configuration. If it is different, the online configuration is downloaded, validated and saved locally. After that all stored packets are removed from memory since they are incompatible with the new configuration.</p>
<p>The systems that use configuration paramaters are updated. The configuration update of the ReadSensorScheduler is in a try-except block because it is possible that it is not yet initialised.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.load_online_configuration_and_initiate_sending_data"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.load_online_configuration_and_initiate_sending_data"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">load_online_configuration_and_initiate_sending_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check online configuration</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">online_checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_configuration_checksum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Checking online configuration..&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_man</span><span class="o">.</span><span class="n">is_online_configuration_different</span><span class="p">(</span><span class="n">online_checksum</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s">&#39;Online configuration is new, updating configuration..&#39;</span><span class="p">)</span>
                <span class="n">online_configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_configuration</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf_man</span><span class="o">.</span><span class="n">validate_json_configuration</span><span class="p">(</span><span class="n">online_configuration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf_man</span><span class="o">.</span><span class="n">save_configuration_local</span><span class="p">(</span>
                    <span class="n">online_checksum</span><span class="p">,</span>
                    <span class="n">online_configuration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">remove_all_packets_from_memory</span><span class="p">()</span>

                <span class="c"># update systems that make use of the configuration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">(</span>
                    <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span>
                    <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read_sensor_scheduler</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Problem updating configuration&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
</pre></div>
</div>
<p>A job is created in the method that loads itself periodically. The time interval between the job is defined in the configuration as parameter <em>timeintervaltocheckonlineconfig</em>.</p>
<p>The last step in the method is to initiate the start of sending packets.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.load_online_configuration_and_initiate_sending_data"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.load_online_configuration_and_initiate_sending_data"> [api]</a><div class="highlight"><pre>            raise
        try:  # try to remove job
            self.scheduler.unschedule_func(
                self.load_online_configuration_and_initiate_sending_data)
        except:
            pass

        # periodically check changes in configuration
        self.scheduler.add_interval_job(
            self.load_online_configuration_and_initiate_sending_data,
            seconds=configuration.get_time_interval_to_check_online_config())

        self.packet_manager.initiate_send_packets(self.connection)
</pre></div>
</div>
</div>
<div class="section" id="wait-for-connection-to-load-configuration">
<span id="id2"></span><h2>wait_for_connection_to_load_configuration()<a class="headerlink" href="#wait-for-connection-to-load-configuration" title="Permalink to this headline">¶</a></h2>
<p>This method is started when there is no internet connection.
If there is no internet connection, it starts a job that periodically checks if there is a connection with internet. If there is an internet connection it checks if there is connection with the server. If it isn&#8217;t, it starts a job that periodically checks if there is a connection with the server.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.wait_for_connection_to_load_configuration"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.wait_for_connection_to_load_configuration"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">wait_for_connection_to_load_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
            <span class="c"># no internet connection, start job to check connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_interval_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">try_to_connect_to_internet</span><span class="p">,</span>
                                            <span class="n">seconds</span><span class="o">=</span><span class="n">CHECK_CONNECTION_INTERVAL</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">update_time</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_server_connection</span><span class="p">():</span>
                <span class="c"># no connection with server, start job to check connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_interval_job</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">try_to_load_online_configuration</span><span class="p">,</span>
                    <span class="n">seconds</span><span class="o">=</span><span class="n">CHECK_CONNECTION_INTERVAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="try-to-connect-to-internet">
<span id="id3"></span><h2>try_to_connect_to_internet()<a class="headerlink" href="#try-to-connect-to-internet" title="Permalink to this headline">¶</a></h2>
<p>This method is started as a job, and checks if there is connection with the internet and the server.</p>
<p>If there is connection with the internet:</p>
<blockquote>
<div><ul class="simple">
<li>It stops itself as a job.</li>
<li>It checks the connection with the server:<ul>
<li>If there is connection with the server it runs <a class="reference internal" href="#load-online-configuration-and-initiate-sending-data"><em>load_online_configuration_and_initiate_sending_data()</em></a>.</li>
<li>If there is no connection with the server it starts <a class="reference internal" href="#try-to-load-online-configuration"><em>try_to_load_online_configuration()</em></a> as a job.</li>
</ul>
</li>
</ul>
</div></blockquote>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.try_to_connect_to_internet"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.try_to_connect_to_internet"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">try_to_connect_to_internet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_internet_connection</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">unschedule_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">try_to_connect_to_internet</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">packet_manager</span><span class="o">.</span><span class="n">update_time</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_server_connection</span><span class="p">():</span>
                    <span class="c"># no connection with server, start job to check connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_interval_job</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">try_to_load_online_configuration</span><span class="p">,</span>
                    <span class="n">seconds</span><span class="o">=</span><span class="n">CHECK_CONNECTION_INTERVAL</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_online_configuration_and_initiate_sending_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="try-to-load-online-configuration">
<span id="id4"></span><h2>try_to_load_online_configuration()<a class="headerlink" href="#try-to-load-online-configuration" title="Permalink to this headline">¶</a></h2>
<p>It there is connection with the server <a class="reference internal" href="#load-online-configuration-and-initiate-sending-data"><em>load_online_configuration_and_initiate_sending_data()</em></a> is run and it stops itself as a job.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.try_to_load_online_configuration"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.try_to_load_online_configuration"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">try_to_load_online_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">check_server_connection</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_online_configuration_and_initiate_sending_data</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">unschedule_func</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">try_to_load_online_configuration</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-led-manager-calls">
<span id="id5"></span><h2>set_up_led_manager_calls()<a class="headerlink" href="#set-up-led-manager-calls" title="Permalink to this headline">¶</a></h2>
<p>For each system that needs to manipulate the state of leds a LedCall is being instantiated and implemented in it.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/datalogger.html#DataLogger.set_up_led_manager_calls"> [source]</a><a class="viewcode-back" href="../modules/datalogger.html#datalogger.DataLogger.set_up_led_manager_calls"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_up_led_manager_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sensor_led_call</span> <span class="o">=</span> <span class="n">LedCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led_manager</span><span class="p">,</span> <span class="n">PinName</span><span class="o">.</span><span class="n">readingsensor</span><span class="p">)</span>
        <span class="n">connected_led_call</span> <span class="o">=</span> <span class="n">LedCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led_manager</span><span class="p">,</span> <span class="n">PinName</span><span class="o">.</span><span class="n">connected</span><span class="p">)</span>
        <span class="n">logging_led_call</span> <span class="o">=</span> <span class="n">LedCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led_manager</span><span class="p">,</span> <span class="n">PinName</span><span class="o">.</span><span class="n">logging</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_sensor_scheduler</span><span class="o">.</span><span class="n">set_led_call</span><span class="p">(</span><span class="n">sensor_led_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_led_call</span><span class="p">(</span><span class="n">connected_led_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_send_store_handler</span><span class="o">.</span><span class="n">set_led_call</span><span class="p">(</span><span class="n">logging_led_call</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="led_manager.html" class="btn btn-neutral float-right" title="Class LedManager">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../code.html" class="btn btn-neutral" title="Code explained"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Jonathan De Beir.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>