

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Class LogSendStoreHandler &mdash; Datalogger 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Datalogger 1 documentation" href="../index.html"/>
        <link rel="up" title="Code explained" href="../code.html"/>
        <link rel="next" title="Class ModbusSlaveReader" href="modbus_slave_reader.html"/>
        <link rel="prev" title="Class ConfigurationManager" href="configuration_manager.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> Datalogger</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Minimum requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installationguide.html">Installation guide</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../code.html">Code explained</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="datalogger.html">Class DataLogger</a></li>
<li class="toctree-l2"><a class="reference internal" href="led_manager.html">Class LedManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_manager.html">Class PacketManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection_manager.html">Class ConnectionManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="read_sensor_scheduler.html">Class ReadSensorScheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration_manager.html">Class ConfigurationManager</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Class LogSendStoreHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="modbus_slave_reader.html">Class ModbusSlaveReader</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/modules.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/datalogger.html">datalogger module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/connection_manager.html">connection_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/packet_manager.html">packet_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/log_handlers_and_filters.html">log_handlers_and_filters module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/configuration_manager.html">configuration_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/configuration.html">configuration module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/led_manager.html">led_manager module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/mcu_modbus_slave_reader.html">mcu_modbus_slave_reader module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/mcu_read_sensor_scheduler.html">mcu_read_sensor_scheduler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modbus_slave_reader.html">modbus_slave_reader module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/read_random_scheduler.html">read_random_scheduler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/read_sensor_scheduler.html">read_sensor_scheduler module</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Datalogger</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../code.html">Code explained</a> &raquo;</li>
      
    <li>Class LogSendStoreHandler</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/code/log_handlers_and_filters.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="class-logsendstorehandler">
<h1>Class LogSendStoreHandler<a class="headerlink" href="#class-logsendstorehandler" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#logsendstore-init"><em>__init__(log_location)</em></a></li>
<li><a class="reference internal" href="#log-update-configuration"><em>update_configuration(**kwargs)</em></a></li>
<li><a class="reference internal" href="#emit"><em>emit(record)</em></a></li>
<li><a class="reference internal" href="#get-log-level-by-string"><em>get_log_level_by_string(levelstring)</em></a></li>
<li><a class="reference internal" href="#initiate-send-logs"><em>initiate_send_logs(connection, scheduler)</em></a></li>
<li><a class="reference internal" href="#initiate-store-logs"><em>initiate_store_logs(scheduler, log_location)</em></a></li>
<li><a class="reference internal" href="#send-logs-job"><em>send_logs_job()</em></a></li>
<li><a class="reference internal" href="#store-logs-job"><em>store_logs_job()</em></a></li>
<li><a class="reference internal" href="#keep-logfile-in-max-limits"><em>keep_logfile_in_max_limits()</em></a></li>
<li><a class="reference internal" href="#examine-logfolder"><em>examine_logfolder()</em></a></li>
<li><a class="reference internal" href="#log-set-led-call"><em>set_led_call(led_call)</em></a></li>
</ul>
</div></blockquote>
<div class="section" id="init-log-location">
<span id="logsendstore-init"></span><h2>__init__(log_location)<a class="headerlink" href="#init-log-location" title="Permalink to this headline">¶</a></h2>
<p>The parent <tt class="docutils literal"><span class="pre">Handler</span></tt> class is initialised. The <tt class="docutils literal"><span class="pre">self.send_logs</span></tt> and <tt class="docutils literal"><span class="pre">self.file_logs</span></tt> lists are made if they don&#8217;t exist yet. The passed parameter <tt class="docutils literal"><span class="pre">log_location</span></tt> is stored. The variable self.configured is set to False. The logger is initialised.  It gives the possibility to see if the last connection to the internet or server was successfull. The configuration is loaded.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_location</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;send_logs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_logs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;file_logs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_logs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_location</span> <span class="o">=</span> <span class="n">log_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_configuration</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="update-configuration-kwargs">
<span id="log-update-configuration"></span><h2>update_configuration(**kwargs)<a class="headerlink" href="#update-configuration-kwargs" title="Permalink to this headline">¶</a></h2>
<p>Different needed parameters are loaded from the configuration. If <tt class="docutils literal"><span class="pre">scheduler</span></tt> is passed and the storage of logs is enabled in the configuration, then the logs store job is started in <a class="reference internal" href="#initiate-store-logs"><em>initiate_store_logs(scheduler, log_location)</em></a>. If <tt class="docutils literal"><span class="pre">scheduler</span></tt> and <tt class="docutils literal"><span class="pre">connection</span></tt> are passed and the sending of logs to the server is enabled in the configuration, then the logs store job is started in <a class="reference internal" href="#initiate-send-logs"><em>initiate_send_logs(connection, scheduler)</em></a>.
This method is run in <a class="reference internal" href="datalogger.html#data-init"><em>__init__()</em></a> when the <a class="reference internal" href="../modules/packet_manager.html#packet_manager.PacketManager" title="packet_manager.PacketManager"><tt class="xref py py-class docutils literal"><span class="pre">PacketManager</span></tt></a> is initialised, the <tt class="xref py py-class docutils literal"><span class="pre">Scheduler</span></tt> is loaded, the <a class="reference internal" href="../modules/connection_manager.html#connection_manager.ConnectionManager" title="connection_manager.ConnectionManager"><tt class="xref py py-class docutils literal"><span class="pre">ConnectionManager</span></tt></a> is loaded and alsa when a new configuration is loaded in (see <a class="reference internal" href="datalogger.html#load-online-configuration-and-initiate-sending-data"><em>load_online_configuration_and_initiate_sending_data()</em></a>).</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.update_configuration"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.update_configuration"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log_level_by_string</span><span class="p">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">get_log_level_to_send_to_server</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log_level_by_string</span><span class="p">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="n">get_log_level_to_store_local</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_interval_to_send_log</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_time_interval_to_send_log</span><span class="p">(</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_interval_to_store_local</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_time_interval_to_store_local</span><span class="p">(</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_log_size</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_max_local_log_size</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">scheduler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;scheduler&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">is_store_logs_local</span><span class="p">()</span> <span class="ow">and</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initiate_store_logs</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_location</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;connection&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">scheduler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;scheduler&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">conn_sched_none</span> <span class="o">=</span> <span class="n">connection</span> <span class="ow">and</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">is_send_logs_to_server</span><span class="p">()</span> <span class="ow">and</span> <span class="n">conn_sched_none</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initiate_send_logs</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;Failed to update configuration of {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__name__</span><span class="p">))</span>
            <span class="k">raise</span>
</pre></div>
</div>
</div>
<div class="section" id="emit-record">
<span id="emit"></span><h2>emit(record)<a class="headerlink" href="#emit-record" title="Permalink to this headline">¶</a></h2>
<p>When a new log is created this method is called. The log is printed to the console and the <a class="reference internal" href="../modules/led_manager.html#led_manager.LedManager" title="led_manager.LedManager"><tt class="xref py py-class docutils literal"><span class="pre">LedManager</span></tt></a> is called to flash a led. After configuration is complete, logs can be stored in <tt class="docutils literal"><span class="pre">self.send_logs</span></tt> and <tt class="docutils literal"><span class="pre">self.file_logs</span></tt>.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.emit"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.emit"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is called when a log is created.</span>
<span class="sd">        If logs needs to be sent or stored, they are stored in their</span>
<span class="sd">        corresponding lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led_call</span><span class="o">.</span><span class="n">flash</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_log_level</span><span class="p">:</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span>
                           <span class="s">&#39;funcName&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">funcName</span><span class="p">,</span>
                           <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                           <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                           <span class="s">&#39;levelno&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">,</span>
                           <span class="s">&#39;timeDate&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_log_level</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="get-log-level-by-string-levelstring">
<span id="get-log-level-by-string"></span><h2>get_log_level_by_string(levelstring)<a class="headerlink" href="#get-log-level-by-string-levelstring" title="Permalink to this headline">¶</a></h2>
<p>This method converts the log level in string format to its numeric value.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.get_log_level_by_string"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.get_log_level_by_string"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_log_level_by_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levelstring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">levelstring</span> <span class="o">==</span> <span class="s">&#39;CRITICAL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50</span>
        <span class="k">elif</span> <span class="n">levelstring</span> <span class="o">==</span> <span class="s">&#39;ERROR&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">40</span>
        <span class="k">elif</span> <span class="n">levelstring</span> <span class="o">==</span> <span class="s">&#39;WARNING&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">30</span>
        <span class="k">elif</span> <span class="n">levelstring</span> <span class="o">==</span> <span class="s">&#39;INFO&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">20</span>
        <span class="k">elif</span> <span class="n">levelstring</span> <span class="o">==</span> <span class="s">&#39;DEBUG&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="initiate-send-logs-connection-scheduler">
<span id="initiate-send-logs"></span><h2>initiate_send_logs(connection, scheduler)<a class="headerlink" href="#initiate-send-logs-connection-scheduler" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../modules/connection_manager.html#connection_manager.ConnectionManager" title="connection_manager.ConnectionManager"><tt class="xref py py-class docutils literal"><span class="pre">ConnectionManager</span></tt></a> instance is implemented. A single scheduled job of <a class="reference internal" href="#send-logs-job"><em>send_logs_job()</em></a> is started.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.initiate_send_logs"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.initiate_send_logs"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">initiate_send_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">unschedule_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_logs_job</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">scheduler</span><span class="o">.</span><span class="n">add_interval_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_logs_job</span><span class="p">,</span>
                                   <span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_interval_to_send_log</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="initiate-store-logs-scheduler-log-location">
<span id="initiate-store-logs"></span><h2>initiate_store_logs(scheduler, log_location)<a class="headerlink" href="#initiate-store-logs-scheduler-log-location" title="Permalink to this headline">¶</a></h2>
<p>First it is checked if the log folder exists, if not it is created. A single scheduled job of <a class="reference internal" href="#store-logs-job"><em>store_logs_job()</em></a> is started.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.initiate_store_logs"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.initiate_store_logs"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">initiate_store_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">log_location</span><span class="p">):</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="s">&quot;datalogger.log&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># check if folder exists, if not: create one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_location</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">log_location</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">log_location</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">log_location</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfolder</span><span class="p">(</span><span class="n">log_location</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">log_location</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Unable to create log folder: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">log_location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">log_location</span><span class="p">,</span>
                <span class="n">base_filename</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">unschedule_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_logs_job</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">scheduler</span><span class="o">.</span><span class="n">add_interval_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_logs_job</span><span class="p">,</span>
                                   <span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_interval_to_store_local</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="send-logs-job">
<span id="id1"></span><h2>send_logs_job()<a class="headerlink" href="#send-logs-job" title="Permalink to this headline">¶</a></h2>
<p>This jobs sends the logs via the <a class="reference internal" href="../modules/connection_manager.html#connection_manager.ConnectionManager" title="connection_manager.ConnectionManager"><tt class="xref py py-class docutils literal"><span class="pre">ConnectionManager</span></tt></a>. If sending of the logs is successfull, the logs that were sent are cleared.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.send_logs_job"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.send_logs_job"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">send_logs_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is called on a time interval set in the configuration.</span>
<span class="sd">        If sending of the logs is successfull, the logs that needs to be sent</span>
<span class="sd">        are cleared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_logs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nr_of_sent_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_logs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nr_of_sent_logs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># successfull sent, clear sent logs</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_logs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nr_of_sent_logs</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="store-logs-job">
<span id="id2"></span><h2>store_logs_job()<a class="headerlink" href="#store-logs-job" title="Permalink to this headline">¶</a></h2>
<p>After running <a class="reference internal" href="#keep-logfile-in-max-limits"><em>keep_logfile_in_max_limits()</em></a> the logs are stored in <tt class="docutils literal"><span class="pre">self.abs_path_log</span></tt>.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.store_logs_job"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.store_logs_job"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">store_logs_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is called on a time interval set in the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_logfile_in_max_limits</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_logs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_logs</span><span class="p">:</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_logs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unable to write log: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="keep-logfile-in-max-limits">
<span id="id3"></span><h2>keep_logfile_in_max_limits()<a class="headerlink" href="#keep-logfile-in-max-limits" title="Permalink to this headline">¶</a></h2>
<p>Organises the logfiles. If a logfile is to big, it is stored under another name and a new logfile is created. If there are too many logfiles, the oldest one is removed. The total max log size is set in the configuration. The individual log file size is set in global variable SINGLE_LOG_FILE_SIZE.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.keep_logfile_in_max_limits"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.keep_logfile_in_max_limits"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">keep_logfile_in_max_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Organises the logfiles.</span>
<span class="sd">        If a logfile is to big, it is stored under another name and a</span>
<span class="sd">        new logfile is created.</span>
<span class="sd">        If there are too many logfiles, the oldest one is removed.</span>
<span class="sd">        The total max log size is set in the configuration. The individual</span>
<span class="sd">        log file size is set in global variable SINGLE_LOG_FILE_SIZE .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_size</span><span class="p">,</span> <span class="n">highest_log_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examine_logfolder</span><span class="p">()</span>

        <span class="c"># remove logs until logs are under max local log size</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_log_size</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">highest_log_number</span><span class="p">))</span>
                <span class="n">highest_log_number</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">total_size</span><span class="p">,</span> <span class="n">highest_log_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examine_logfolder</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unable to remove log file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">highest_log_number</span><span class="p">)))</span>

        <span class="c"># rename logs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">SINGLE_LOG_FILE_SIZE</span><span class="p">:</span>
                    <span class="n">log_nr</span> <span class="o">=</span> <span class="n">highest_log_number</span>
                    <span class="k">while</span> <span class="n">log_nr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_nr</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">log_nr</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span> <span class="o">+</span> <span class="s">&#39;.0&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s">&#39;Unable to rename log file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="examine-logfolder">
<span id="id4"></span><h2>examine_logfolder()<a class="headerlink" href="#examine-logfolder" title="Permalink to this headline">¶</a></h2>
<p>Is used in <a class="reference internal" href="#keep-logfile-in-max-limits"><em>keep_logfile_in_max_limits()</em></a> to calculate the total log size, and the biggest log number.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.examine_logfolder"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.examine_logfolder"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">examine_logfolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">highest_log_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log_folder</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_path_log</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">highest_log_nr</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">:</span>
                            <span class="n">highest_log_nr</span> <span class="o">=</span> <span class="n">nr</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c"># nr is not a number</span>
                        <span class="k">pass</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">highest_log_nr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="set-led-call-led-call">
<span id="log-set-led-call"></span><h2>set_led_call(led_call)<a class="headerlink" href="#set-led-call-led-call" title="Permalink to this headline">¶</a></h2>
<p>This method implements the <a class="reference internal" href="../modules/led_manager.html#led_manager.LedCall" title="led_manager.LedCall"><tt class="xref py py-class docutils literal"><span class="pre">LedCall</span></tt></a> instance.</p>
<div class="highlight-python"><a class="viewcode-back" href="../_modules/log_handlers_and_filters.html#LogSendStoreHandler.set_led_call"> [source]</a><a class="viewcode-back" href="../modules/log_handlers_and_filters.html#log_handlers_and_filters.LogSendStoreHandler.set_led_call"> [api]</a><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_led_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">led_call</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_call</span> <span class="o">=</span> <span class="n">led_call</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="modbus_slave_reader.html" class="btn btn-neutral float-right" title="Class ModbusSlaveReader">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuration_manager.html" class="btn btn-neutral" title="Class ConfigurationManager"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Jonathan De Beir.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>